--- /Users/julienmiquel/dev/speech-main/article-to-speech/app.py	2026-02-24 14:43:34
+++ /Users/julienmiquel/dev/speech/article-to-speech/app.py	2026-02-22 21:32:55
@@ -26,7 +26,7 @@
 st.set_page_config(page_title="Gemini TTS Workshop", layout="wide")
 
 st.title("üéôÔ∏è Le Figaro x Gemini TTS Factory")
-st.markdown("Workshop Demo: Article to Audio using Gemini 2.0 Flash & Gemini 2.5 Pro")
+st.markdown("Workshop Demo: Article to Audio using Gemini 2.5 Flash & Gemini 2.5 Pro TTS")
 
 # Ensure assets directory exists globally
 if not os.path.exists("assets"):
@@ -87,7 +87,13 @@
 except ValueError: idx_parse = 0
 model_parse = st.sidebar.selectbox("Parsing Model (Structure)", parse_models, index=idx_parse)
 
-synth_models = ["gemini-2.5-pro-tts", "gemini-2.5-flash-tts", "gemini-2.5-flash-lite-preview-tts"]
+MODELS_CONFIG = {
+    "gemini-2.5-pro-tts": {"multi_speaker": True, "default_format": "wav"},
+    "gemini-2.5-flash-tts": {"multi_speaker": True, "default_format": "wav"},
+    "gemini-2.5-flash-lite-preview-tts": {"multi_speaker": False, "default_format": "wav"}
+}
+
+synth_models = list(MODELS_CONFIG.keys())
 try: idx_synth = synth_models.index(DEFAULT_MODEL_SYNTH)
 except ValueError: idx_synth = 0
 model_synth = st.sidebar.selectbox("Synthesis Model (Audio)", synth_models, index=idx_synth)
@@ -171,17 +177,21 @@
     
     # 1. Individual Entry Editor
     st.subheader("Ajouter une entr√©e")
-    new_word = st.text_input("Mot d'origine", key="new_word_dict", placeholder="Fillon")
-    new_pron = st.text_input("Prononciation", key="new_pron_dict", placeholder="Fi-yon")
+    new_word = st.text_input("Mot d'origine", key="new_word_dict", placeholder="Shein")
+    new_pron_inline = st.text_input("Prononciation (Inline / Pseudo-phon√©tique)", key="new_pron_inline_dict", placeholder="Chi-ine")
+    new_pron_ipa = st.text_input("Prononciation (IPA / Exacte)", key="new_pron_ipa_dict", placeholder=" Éi.in")
     
     if st.button("‚ûï Ajouter", use_container_width=True):
-        if new_word and new_pron:
-            pronunciation_dict[new_word] = new_pron
+        if new_word and (new_pron_inline or new_pron_ipa):
+            pronunciation_dict[new_word] = {
+                "inline": new_pron_inline,
+                "ipa": new_pron_ipa
+            }
             if save_pronunciation_dictionary(pronunciation_dict):
                 st.success(f"Ajout√©: {new_word}")
                 st.rerun()
         else:
-            st.error("Veuillez remplir les deux champs.")
+            st.error("Veuillez remplir le mot d'origine et au moins une prononciation.")
             
     st.markdown("---")
     
@@ -205,7 +215,13 @@
     st.subheader("Entr√©es actuelles")
     for word, pron in list(pronunciation_dict.items()):
         col_text, col_del = st.columns([4, 1])
-        col_text.text(f"{word} ‚Üí {pron}")
+        
+        if isinstance(pron, dict):
+            disp = f"{word} ‚Üí Inline: '{pron.get('inline','')}' | IPA: '{pron.get('ipa','')}'"
+        else:
+            disp = f"{word} ‚Üí {pron} (Ancien format)"
+            
+        col_text.text(disp)
         if col_del.button("üóëÔ∏è", key=f"del_dict_{word}"):
             del pronunciation_dict[word]
             if save_pronunciation_dictionary(pronunciation_dict):
@@ -234,52 +250,75 @@
     return re.sub(r'[^a-zA-Z0-9]', '_', text).strip('_')
 
 def render_generator():
-    # Presets from tts_requirements.md
-    presets = {
-        "Custom URL": "",
-        "Long Article (Quotes + Enrichments)": "https://www.lefigaro.fr/politique/j-ai-pris-la-decision-d-etre-candidat-de-la-place-beauvau-a-la-conquete-de-l-elysee-la-mue-presidentielle-de-bruno-retailleau-20260212",
-        "Editorial": "https://www.lefigaro.fr/vox/economie/l-editorial-de-gaetan-de-capele-strategie-energetique-il-faut-sanctuariser-le-nucleaire-20260211",
-        "Economy (Figures)": "https://www.lefigaro.fr/conjoncture/l-industrie-automobile-francaise-a-perdu-un-tiers-de-ses-effectifs-entre-2010-et-2023-constate-l-insee-20260212",
-        "Interview (Q&A)": "https://www.lefigaro.fr/musique/lord-kossity-le-rap-c-est-un-art-et-la-jeune-generation-fait-tout-sauf-du-rap-20260211",
-        "International (Foreign Names)": "https://www.lefigaro.fr/international/le-pentagone-prepare-le-deploiement-d-un-deuxieme-porte-avions-pour-accroitre-la-pression-sur-l-iran-selon-le-wall-street-journal-20260212",
-        "Brands (Shein)": "https://www.lefigaro.fr/conso/les-plateformes-d-ultra-fast-fashion-seduisent-toujours-plus-d-un-francais-sur-trois-en-2025-d-apres-une-etude-20260212"
-    }
+    # Source Selection
+    st.subheader("1. Source du texte")
+    source_option = st.radio("M√©thode de saisie", ["Saisie Manuelle", "URL Article"], index=0, horizontal=True)
 
-    # Selection logic: Only update url_input if the preset selection actually CHANGED
-    if "last_preset" not in st.session_state:
-        st.session_state.last_preset = "Custom URL"
-
-    selected_preset = st.selectbox("Load Example Article", list(presets.keys()))
-
-    if "url_input" not in st.session_state:
-        st.session_state.url_input = "https://www.lefigaro.fr/meteo/meteo-decouvrez-les-16-departements-places-en-vigilance-orange-crues-ou-pluie-inondation-ce-11-fevrier-20260210"
-
-    # If user changed the preset, update the url_input
-    if selected_preset != st.session_state.last_preset:
-        st.session_state.last_preset = selected_preset
-        if selected_preset != "Custom URL":
-             st.session_state.url_input = presets[selected_preset]
-             st.rerun()
-
     # Automation Button at the top for convenience
     if st.button("üöÄ TOUT R√âALISER ( extraction + prononciation + structure )", use_container_width=True):
         st.session_state.run_automation = True
 
-    # Main Area
-    url = st.text_input("Article URL", key="url_input")
-    
-    # State Management: Clear previous processing if URL changes
-    if "last_url" not in st.session_state:
-        # Initialize last_url to current url to prevent clearing on first load
-        st.session_state.last_url = url
+    if source_option == "URL Article":
+        # Presets from tts_requirements.md
+        presets = {
+            "Custom URL": "",
+            "Long Article (Quotes + Enrichments)": "https://www.lefigaro.fr/politique/j-ai-pris-la-decision-d-etre-candidat-de-la-place-beauvau-a-la-conquete-de-l-elysee-la-mue-presidentielle-de-bruno-retailleau-20260212",
+            "Editorial": "https://www.lefigaro.fr/vox/economie/l-editorial-de-gaetan-de-capele-strategie-energetique-il-faut-sanctuariser-le-nucleaire-20260211",
+            "Economy (Figures)": "https://www.lefigaro.fr/conjoncture/l-industrie-automobile-francaise-a-perdu-un-tiers-de-ses-effectifs-entre-2010-et-2023-constate-l-insee-20260212",
+            "Interview (Q&A)": "https://www.lefigaro.fr/musique/lord-kossity-le-rap-c-est-un-art-et-la-jeune-generation-fait-tout-sauf-du-rap-20260211",
+            "International (Foreign Names)": "https://www.lefigaro.fr/international/le-pentagone-prepare-le-deploiement-d-un-deuxieme-porte-avions-pour-accroitre-la-pression-sur-l-iran-selon-le-wall-street-journal-20260212",
+            "Brands (Shein)": "https://www.lefigaro.fr/conso/les-plateformes-d-ultra-fast-fashion-seduisent-toujours-plus-d-un-francais-sur-trois-en-2025-d-apres-une-etude-20260212"
+        }
+
+        # Selection logic: Only update url_input if the preset selection actually CHANGED
+        if "last_preset" not in st.session_state:
+            st.session_state.last_preset = "Custom URL"
+
+        selected_preset = st.selectbox("Load Example Article", list(presets.keys()))
+
+        if "url_input" not in st.session_state:
+            st.session_state.url_input = "https://www.lefigaro.fr/meteo/meteo-decouvrez-les-16-departements-places-en-vigilance-orange-crues-ou-pluie-inondation-ce-11-fevrier-20260210"
+
+        # If user changed the preset, update the url_input
+        if selected_preset != st.session_state.last_preset:
+            st.session_state.last_preset = selected_preset
+            if selected_preset != "Custom URL":
+                 st.session_state.url_input = presets[selected_preset]
+                 st.rerun()
+
+        url = st.text_input("Article URL", key="url_input")
         
-    if url != st.session_state.last_url:
-        logging.info(f"URL changed from '{st.session_state.last_url}' to '{url}'. Clearing extraction/analysis state.")
-        st.session_state.last_url = url
-        st.session_state.text_content = ""
-        if "dialogue" in st.session_state:
-            del st.session_state.dialogue
-    
+        # State Management: Clear previous processing if URL changes
+        if "last_url" not in st.session_state:
+            # Initialize last_url to current url to prevent clearing on first load
+            st.session_state.last_url = url
+            
+        if url != st.session_state.last_url:
+            logging.info(f"URL changed from '{st.session_state.last_url}' to '{url}'. Clearing extraction/analysis state.")
+            st.session_state.last_url = url
+            st.session_state.text_content = ""
+            if "dialogue" in st.session_state:
+                del st.session_state.dialogue
+
+        st.subheader("Extraire texte brut")
+        extraction_method = st.radio("M√©thode d'extraction", [f"{model_parse} (Smart)", "BeautifulSoup (Standard)"], index=0, horizontal=True)
+    else:
+        url = "Saisie Manuelle"
+        extraction_method = "Saisie Manuelle"
+        
+        if "manual_text_input" not in st.session_state:
+            st.session_state.manual_text_input = ""
+            
+        st.subheader("Saisissez votre texte")
+        st.text_area("Texte √† synth√©tiser (Saisie Manuelle)", height=200, key="manual_text_input")
+        
+        if st.button("Valider le texte"):
+            if st.session_state.manual_text_input.strip() != st.session_state.get("text_content", "").strip():
+                st.session_state.text_content = st.session_state.manual_text_input
+                if "dialogue" in st.session_state:
+                    del st.session_state.dialogue
+            st.success(f"Texte valid√© ({len(st.session_state.text_content)} caract√®res).")
+
     system_prompts = {
         "Standard": SYSTEM_PROMPT_STANDARD,
         "Figaro Smart (Rich Content)": SYSTEM_PROMPT_FIGARO_SMART
@@ -298,9 +337,6 @@
     if "pg_p_sidebar" not in st.session_state:
         st.session_state.pg_p_sidebar = PROMPT_REPORTER
 
-    st.subheader("1. Extraire texte brut ou URL")
-    extraction_method = st.radio("M√©thode d'extraction", [f"{model_parse} (Smart)", "BeautifulSoup (Standard)"], index=0, horizontal=True)
-    
     # Tips Section based on Feedback
     with st.expander("üí° Tips & Guide (Feedbacks Figaro)", expanded=False):
         st.markdown("""
@@ -319,7 +355,7 @@
 
         system_prompt = st.text_area("System Prompt (Parsing)", value=default_system_prompt, height=300)
         
-    if st.button("Extraire le Texte"):
+    if source_option == "URL Article" and st.button("Extraire le Texte"):
         logging.info(f"Checking cache or starting extraction for URL: {url}")
         
         # Check cache first
@@ -349,7 +385,14 @@
         st.session_state.run_automation = False # Reset
         with st.status("üõ†Ô∏è Automatisation en cours...", expanded=True) as status:
             # 1. Extraction (if needed)
-            if not st.session_state.text_content:
+            status.update(label="1. Pr√©paration du texte...")
+            if source_option == "Saisie Manuelle":
+                if st.session_state.get("manual_text_input"):
+                    if st.session_state.manual_text_input.strip() != st.session_state.get("text_content", "").strip():
+                        st.session_state.text_content = st.session_state.manual_text_input
+                        if "dialogue" in st.session_state:
+                            del st.session_state.dialogue
+            elif not st.session_state.text_content and source_option == "URL Article":
                 status.update(label="1. Extraction du texte...")
                 cached_text = get_cached_text(url)
                 if cached_text:
@@ -376,7 +419,8 @@
                     if added > 0:
                         st.info(f"‚ûï {added} nouveaux termes ajout√©s au dictionnaire global.")
                     
-                    guides_text = "\nConsignes de prononciation :\n" + "\n".join([f"- {g['term']} se prononce '{g['guide']}'" for g in guides])
+                    # Fallback for old cached 'guide'
+                    guides_text = "\nConsignes de prononciation :\n" + "\n".join([f"- {g['term']} se prononce '{g.get('inline', g.get('guide', g.get('ipa', '')))}'" for g in guides])
                     st.session_state.pg_p_main += guides_text
                     st.session_state.pg_p_sidebar += guides_text
                 
@@ -413,10 +457,14 @@
         if "pronunciation_guides" in st.session_state and st.session_state.pronunciation_guides:
             with st.expander("Guides de prononciation trouv√©s", expanded=True):
                 for g in st.session_state.pronunciation_guides:
-                    st.write(f"- **{g['term']}** : {g['guide']}")
+                    disp_text = f"- **{g['term']}** : "
+                    if 'inline' in g and g['inline']: disp_text += f"Inline: '{g['inline']}' "
+                    if 'ipa' in g and g['ipa']: disp_text += f"| IPA: '{g['ipa']}'"
+                    if 'guide' in g: disp_text += f"{g['guide']}"
+                    st.write(disp_text)
                 
                 if st.button("Appliquer comme consignes (Prompts)"):
-                    guides_text = "\nConsignes de prononciation :\n" + "\n".join([f"- {g['term']} se prononce '{g['guide']}'" for g in st.session_state.pronunciation_guides])
+                    guides_text = "\nConsignes de prononciation :\n" + "\n".join([f"- {g['term']} se prononce '{g.get('inline', g.get('guide', g.get('ipa', '')))}'" for g in st.session_state.pronunciation_guides])
                     st.session_state.pg_p_main += guides_text
                     st.session_state.pg_p_sidebar += guides_text
                     st.success("Guides ajout√©s aux prompts de synth√®se !")
@@ -617,24 +665,33 @@
                     
                     # Generate unique filename
                     timestamp = int(time.time())
-                    outfile_name = f"assets/single_{timestamp}.wav"
+                    ext = MODELS_CONFIG.get(model_synth, {}).get("default_format", "wav")
+                    outfile_name = f"assets/single_{timestamp}.{ext}"
                     
+                    progress_bar_single = st.progress(0, text="Pr√©paration de la synth√®se...")
+                    audio_container_single = st.container()
+                    def update_progress_single(current, total, audio_bytes=None):
+                        progress_bar_single.progress(current / total, text=f"Synth√®se vocale (Lot {current}/{total})...")
+                        if audio_bytes:
+                            audio_container_single.audio(audio_bytes, format="audio/wav")
+                        
                     start_time = time.time()
-                    outfile, status, usage = synthesize_multi_speaker(
-                        single_dialogue, 
-                        model=model_synth, 
-                        voice_main=voice_main, 
-                        voice_sidebar=voice_main,
+                    
+                    text_to_read = "\n\n".join([d["text"] for d in single_dialogue])
+                    outfile, status, usage = synthesize_and_save(
+                        text=text_to_read,
+                        model=model_synth,
+                        voice=voice_main,
                         output_file=outfile_name,
-                        strict_mode=strict_mode,
-                        prompt_main=prompt_main,
-                        prompt_sidebar=prompt_sidebar,
-                        seed=seed,
-                        temperature=temperature,
                         apply_dictionary=apply_dictionary,
-                        language=language
+                        system_instruction=prompt_main,
+                        language=language,
+                        progress_callback=update_progress_single
                     )
+                    
                     duration = time.time() - start_time
+                    progress_bar_single.empty()
+                    
                     update_token_usage(usage)
                     if outfile:
                         if status and status.get("state") == "truncated":
@@ -652,12 +709,24 @@
                         st.success(f"Sauvegard√© : {final_ref}")
                         
         with c2:
-            if st.button("G√©n√©rer Double Voix"):
+            st.write("") # spacer
+            is_multi_speaker_supported = MODELS_CONFIG.get(model_synth, {}).get("multi_speaker", True)
+            if not is_multi_speaker_supported:
+                st.button("G√©n√©rer Double Voix (‚ùå Non support√©)", disabled=True)
+            elif st.button("G√©n√©rer Double Voix"):
                 with st.spinner("Synth√®se Double Voix..."):
                      # Generate unique filename
                      timestamp = int(time.time())
-                     outfile_name = f"assets/dual_{timestamp}.wav"
+                     ext = MODELS_CONFIG.get(model_synth, {}).get("default_format", "wav")
+                     outfile_name = f"assets/dual_{timestamp}.{ext}"
     
+                     progress_bar_dual = st.progress(0, text="Pr√©paration de la synth√®se...")
+                     audio_container_dual = st.container()
+                     def update_progress_dual(current, total, audio_bytes=None):
+                         progress_bar_dual.progress(current / total, text=f"Synth√®se vocale (Lot {current}/{total})...")
+                         if audio_bytes:
+                             audio_container_dual.audio(audio_bytes, format="audio/wav")
+                         
                      start_time = time.time()
                      outfile, status, usage = synthesize_multi_speaker(
                         st.session_state.dialogue, 
@@ -672,9 +741,12 @@
                         temperature=temperature,
                         apply_dictionary=apply_dictionary,
                         delay_seconds=delay_seconds,
-                        language=language
+                        language=language,
+                        progress_callback=update_progress_dual
                     )
                      duration = time.time() - start_time
+                     progress_bar_dual.empty()
+                     
                      update_token_usage(usage)
                      if outfile:
                         if status and status.get("state") == "truncated":
@@ -1140,7 +1212,7 @@
                          try:
                             st.session_state.storage.download_file(audio_file, local_path)
                          except Exception as e:
-                             logging.warning(f"Could not download audio (likely 404): {e}")
+                             st.warning(f"Could not download audio: {e}")
                              local_path = None
                 
                 if local_path and os.path.exists(local_path):
@@ -1174,14 +1246,43 @@
 def render_playground():
     st.subheader("üõù Playground (Constructeur de Script)")
     st.markdown("Construisez votre script bloc par bloc ou chargez un fichier JSON.")
-
-    # initialize session state for playground dialogue if not exists
-    if "playground_dialogue" not in st.session_state:
-        st.session_state.playground_dialogue = [
+    
+    # Define demo texts for different languages
+    demo_texts = {
+        "Fran√ßais (FR)": [
             {"speaker": "R", "text": "Bonjour ! Nous sommes ravis de vous pr√©senter nos capacit√©s de synth√®se vocale.", "prompt": ""},
             {"speaker": "S", "text": "O√π vous pouvez diriger une voix, cr√©er des dialogues r√©alistes, et bien plus encore.", "prompt": ""}
+        ],
+        "English (EN)": [
+            {"speaker": "R", "text": "Hello! We are thrilled to introduce our text-to-speech synthesis capabilities.", "prompt": ""},
+            {"speaker": "S", "text": "Where you can direct a voice, create realistic dialogue, and much more.", "prompt": ""}
+        ],
+        "Deutsch (DE)": [
+            {"speaker": "R", "text": "Hallo! Wir freuen uns, Ihnen unsere Funktionen zur Sprachsynthese vorzustellen.", "prompt": ""},
+            {"speaker": "S", "text": "Hier k√∂nnen Sie eine Stimme lenken, realistische Dialoge erstellen und vieles mehr.", "prompt": ""}
+        ],
+        "Espa√±ol (ES)": [
+            {"speaker": "R", "text": "¬°Hola! Estamos encantados de presentar nuestras capacidades de s√≠ntesis de voz.", "prompt": ""},
+            {"speaker": "S", "text": "Donde puedes dirigir una voz, crear di√°logos realistas y mucho m√°s.", "prompt": ""}
         ]
+    }
+    
+    st.markdown("---")
+    demo_lang = st.selectbox("Langue de d√©monstration", list(demo_texts.keys()), index=0)
 
+    # Initialize session state for playground dialogue if not exists
+    if "playground_dialogue" not in st.session_state:
+        st.session_state.playground_dialogue = demo_texts[list(demo_texts.keys())[0]]
+        st.session_state.demo_lang = list(demo_texts.keys())[0]
+
+    # Handle language switch (update demo text if changed)
+    if "demo_lang" not in st.session_state or st.session_state.demo_lang != demo_lang:
+        st.session_state.demo_lang = demo_lang
+        # Only overwrite if the user is using the default demo (don't overwrite their custom work without asking)
+        # For simplicity in demo mode, we will overwrite on select box change.
+        st.session_state.playground_dialogue = demo_texts[demo_lang]
+        st.rerun()
+
     # Layout: Left (JSON/Config) - Right (Visual Builder)
     col1, col2 = st.columns([1, 2])
 
@@ -1266,7 +1367,10 @@
         seed_pg = c_seed_pg.number_input("Seed", value=42, min_value=0, step=1, key="pg_seed")
         temperature_pg = c_temp_pg.slider("Temperature", min_value=0.0, max_value=2.0, value=0.0, step=0.1, key="pg_temp")
 
-    if st.button("G√©n√©rer l'audio du script", key="pg_generate", type="primary", use_container_width=True):
+    is_multi_speaker_supported = MODELS_CONFIG.get(model_synth, {}).get("multi_speaker", True)
+    if not is_multi_speaker_supported:
+        st.button("G√©n√©rer l'audio du script (‚ùå Non support√©)", key="pg_generate_disabled", type="primary", use_container_width=True, disabled=True)
+    elif st.button("G√©n√©rer l'audio du script", key="pg_generate", type="primary", use_container_width=True):
         if not st.session_state.playground_dialogue:
             st.error("Le script est vide.")
         else:
@@ -1276,6 +1380,13 @@
                 
                 dialogue_to_synth = st.session_state.playground_dialogue
                 
+                progress_bar_pg = st.progress(0, text="Pr√©paration de la synth√®se du script...")
+                audio_container_pg = st.container()
+                def update_progress_pg(current, total, audio_bytes=None):
+                    progress_bar_pg.progress(current / total, text=f"Synth√®se du script (Lot {current}/{total})...")
+                    if audio_bytes:
+                        audio_container_pg.audio(audio_bytes, format="audio/wav")
+                    
                 outfile, status, usage = synthesize_multi_speaker(
                     dialogue_to_synth, 
                     model=model_synth, 
@@ -1288,8 +1399,11 @@
                     seed=seed_pg,
                     temperature=temperature_pg,
                     apply_dictionary=apply_dictionary,
-                    language=language
+                    language=language,
+                    progress_callback=update_progress_pg
                 )
+                progress_bar_pg.empty()
+                
                 update_token_usage(usage)
                 
                 if outfile:
